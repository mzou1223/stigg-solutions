"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TimeoutLink = void 0;
const core_1 = require("@apollo/client/core");
const OperationTimeoutError_1 = require("./OperationTimeoutError");
class TimeoutLink extends core_1.ApolloLink {
    constructor(timeout = 30000) {
        super();
        this.timeout = timeout;
    }
    request(operation, forward) {
        return new core_1.Observable((observer) => {
            const timeout = operation.getContext().timeout || this.timeout;
            const timerHandle = setTimeout(() => {
                observer.error(new OperationTimeoutError_1.OperationTimeoutError(operation.operationName, timeout));
            }, timeout);
            if (!forward) {
                return;
            }
            const subscription = forward(operation).subscribe({
                next: (result) => {
                    clearTimeout(timerHandle);
                    observer.next(result);
                },
                error: (error) => {
                    clearTimeout(timerHandle);
                    observer.error(error);
                },
                complete: () => {
                    clearTimeout(timerHandle);
                    observer.complete();
                },
            });
            return () => {
                clearTimeout(timerHandle);
                subscription.unsubscribe();
            };
        });
    }
}
exports.TimeoutLink = TimeoutLink;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZW91dExpbmsuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL2Fwb2xsby9UaW1lb3V0TGluay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4Q0FBcUY7QUFFckYsbUVBQWdFO0FBRWhFLE1BQWEsV0FBWSxTQUFRLGlCQUFVO0lBQ3pDLFlBQTZCLFVBQVUsS0FBTTtRQUMzQyxLQUFLLEVBQUUsQ0FBQztRQURtQixZQUFPLEdBQVAsT0FBTyxDQUFTO0lBRTdDLENBQUM7SUFFTSxPQUFPLENBQUMsU0FBb0IsRUFBRSxPQUFrQjtRQUNyRCxPQUFPLElBQUksaUJBQVUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUMvRCxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNsQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksNkNBQXFCLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQzlFLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVaLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ1osT0FBTzthQUNSO1lBRUQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQkFDaEQsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUU7b0JBQ2YsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUMxQixRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN4QixDQUFDO2dCQUNELEtBQUssRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUNmLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztvQkFDMUIsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDeEIsQ0FBQztnQkFDRCxRQUFRLEVBQUUsR0FBRyxFQUFFO29CQUNiLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztvQkFDMUIsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUN0QixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsT0FBTyxHQUFHLEVBQUU7Z0JBQ1YsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUMxQixZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0IsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFyQ0Qsa0NBcUNDIn0=