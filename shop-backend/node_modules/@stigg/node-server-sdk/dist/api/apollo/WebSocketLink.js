"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketLink = void 0;
const core_1 = require("@apollo/client/core");
const graphql_ws_1 = require("graphql-ws");
const graphql_1 = require("graphql");
class WebSocketLink extends core_1.ApolloLink {
    constructor(options, loggerService) {
        super();
        this.loggerService = loggerService;
        this.client = (0, graphql_ws_1.createClient)(Object.assign({}, options));
    }
    request(operation) {
        return new core_1.Observable((sink) => {
            return this.client.subscribe(Object.assign(Object.assign({}, operation), { query: (0, graphql_1.print)(operation.query) }), {
                next: sink.next.bind(sink),
                complete: sink.complete.bind(sink),
                error: (error) => {
                    const errorReason = error.message || error.reason;
                    if (errorReason.includes('ThrottlerException')) {
                        this.loggerService.log(`Websocket disconnected. reason: Throttle error`);
                    }
                    else {
                        // Error can be also a close event.
                        this.loggerService.error(`Websocket disconnected. reason: ${errorReason || 'connection closed'}`);
                    }
                    sink.error(error);
                },
            });
        });
    }
}
exports.WebSocketLink = WebSocketLink;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0TGluay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvYXBvbGxvL1dlYlNvY2tldExpbmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOENBQXFGO0FBQ3JGLDJDQUFpRTtBQUVqRSxxQ0FBZ0M7QUFFaEMsTUFBYSxhQUFjLFNBQVEsaUJBQVU7SUFHM0MsWUFBWSxPQUFzQixFQUFtQixhQUE0QjtRQUMvRSxLQUFLLEVBQUUsQ0FBQztRQUQyQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUUvRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUEseUJBQVksb0JBQ3JCLE9BQU8sRUFDVixDQUFDO0lBQ0wsQ0FBQztJQUVNLE9BQU8sQ0FBQyxTQUFvQjtRQUNqQyxPQUFPLElBQUksaUJBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQzdCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLGlDQUNyQixTQUFTLEtBQUUsS0FBSyxFQUFFLElBQUEsZUFBSyxFQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FDN0M7Z0JBQ0UsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDMUIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDbEMsS0FBSyxFQUFFLENBQUMsS0FBVSxFQUFFLEVBQUU7b0JBQ3BCLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQztvQkFDbEQsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLEVBQUU7d0JBQzlDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7cUJBQzFFO3lCQUFNO3dCQUNMLG1DQUFtQzt3QkFDbkMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsbUNBQW1DLFdBQVcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDLENBQUM7cUJBQ25HO29CQUVELElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BCLENBQUM7YUFDRixDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQWhDRCxzQ0FnQ0MifQ==