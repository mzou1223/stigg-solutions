"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.intializeStiggDependencies = void 0;
const eventEmitter_1 = require("./services/eventEmitter");
const inMemoryCacheService_1 = require("./services/cache/inMemoryCacheService");
const initApolloClient_1 = __importDefault(require("./api/apollo/initApolloClient"));
const redisEntitlementsService_1 = require("./services/redisEntitlementsService");
const redisCacheService_1 = require("./services/cache/redisCacheService");
const inMemoryEntitlementsService_1 = require("./services/inMemoryEntitlementsService");
const managementApi_1 = __importDefault(require("./api/managementApi"));
const sdkConfigurationApi_1 = __importDefault(require("./api/sdkConfigurationApi"));
const EdgeApiClient_1 = require("./services/EdgeApiClient");
const cacheInstrumentation_1 = require("./services/cacheInstrumentation");
const intializeStiggDependencies = (isPersistedCacheEnabled, sdkConfiguration, loggerService) => {
    const eventEmitter = new eventEmitter_1.TypedEventEmitter();
    const cacheInstrumentation = new cacheInstrumentation_1.CacheInstrumentation(eventEmitter);
    let inMemoryCacheService = null;
    let entitlementsService;
    if (!isPersistedCacheEnabled) {
        inMemoryCacheService = new inMemoryCacheService_1.InMemoryCacheService(sdkConfiguration.memoryCacheMaxSizeBytes, cacheInstrumentation);
    }
    const graphqlClient = (0, initApolloClient_1.default)(Object.assign(Object.assign({}, sdkConfiguration), { onConnected: (inMemoryCacheService === null || inMemoryCacheService === void 0 ? void 0 : inMemoryCacheService.clearCache) || Promise.resolve, loggerService }));
    const edgeApiClient = EdgeApiClient_1.EdgeApiClient.create(sdkConfiguration, loggerService);
    const { entitlementsTimeout } = sdkConfiguration;
    if (isPersistedCacheEnabled) {
        entitlementsService = new redisEntitlementsService_1.RedisEntitlementsService(new redisCacheService_1.RedisCacheService(sdkConfiguration, loggerService, cacheInstrumentation), graphqlClient, loggerService, edgeApiClient, entitlementsTimeout);
    }
    else if (inMemoryCacheService) {
        entitlementsService = new inMemoryEntitlementsService_1.InMemoryEntitlementsService(inMemoryCacheService, graphqlClient, eventEmitter, loggerService, edgeApiClient, entitlementsTimeout);
    }
    else {
        throw new Error(`Failed to initialize SDK`);
    }
    const managementApi = new managementApi_1.default(graphqlClient, edgeApiClient);
    const sdkConfigurationApi = new sdkConfigurationApi_1.default(graphqlClient, edgeApiClient);
    return { eventEmitter, entitlementsService, managementApi, sdkConfigurationApi };
};
exports.intializeStiggDependencies = intializeStiggDependencies;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50SW5pdGlhbGl6YXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2xpZW50SW5pdGlhbGl6YXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUEsMERBQTREO0FBQzVELGdGQUE2RTtBQUU3RSxxRkFBNkQ7QUFDN0Qsa0ZBQStFO0FBQy9FLDBFQUF1RTtBQUN2RSx3RkFBcUY7QUFDckYsd0VBQWdEO0FBQ2hELG9GQUE0RDtBQUM1RCw0REFBeUQ7QUFDekQsMEVBQXVFO0FBRWhFLE1BQU0sMEJBQTBCLEdBQUcsQ0FDeEMsdUJBQWdDLEVBQ2hDLGdCQUErQyxFQUMvQyxhQUE0QixFQUM1QixFQUFFO0lBQ0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBaUIsRUFBRSxDQUFDO0lBQzdDLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSwyQ0FBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNwRSxJQUFJLG9CQUFvQixHQUFnQyxJQUFJLENBQUM7SUFDN0QsSUFBSSxtQkFBd0MsQ0FBQztJQUU3QyxJQUFJLENBQUMsdUJBQXVCLEVBQUU7UUFDNUIsb0JBQW9CLEdBQUcsSUFBSSwyQ0FBb0IsQ0FBQyxnQkFBZ0IsQ0FBQyx1QkFBdUIsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0tBQ2pIO0lBRUQsTUFBTSxhQUFhLEdBQUcsSUFBQSwwQkFBZ0Isa0NBQ2pDLGdCQUFnQixLQUNuQixXQUFXLEVBQUUsQ0FBQSxvQkFBb0IsYUFBcEIsb0JBQW9CLHVCQUFwQixvQkFBb0IsQ0FBRSxVQUFVLEtBQUksT0FBTyxDQUFDLE9BQU8sRUFDaEUsYUFBYSxJQUNiLENBQUM7SUFFSCxNQUFNLGFBQWEsR0FBRyw2QkFBYSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM1RSxNQUFNLEVBQUUsbUJBQW1CLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQztJQUVqRCxJQUFJLHVCQUF1QixFQUFFO1FBQzNCLG1CQUFtQixHQUFHLElBQUksbURBQXdCLENBQ2hELElBQUkscUNBQWlCLENBQUMsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLG9CQUFvQixDQUFDLEVBQzVFLGFBQWEsRUFDYixhQUFhLEVBQ2IsYUFBYSxFQUNiLG1CQUFtQixDQUNwQixDQUFDO0tBQ0g7U0FBTSxJQUFJLG9CQUFvQixFQUFFO1FBQy9CLG1CQUFtQixHQUFHLElBQUkseURBQTJCLENBQ25ELG9CQUFvQixFQUNwQixhQUFhLEVBQ2IsWUFBWSxFQUNaLGFBQWEsRUFDYixhQUFhLEVBQ2IsbUJBQW1CLENBQ3BCLENBQUM7S0FDSDtTQUFNO1FBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0tBQzdDO0lBRUQsTUFBTSxhQUFhLEdBQUcsSUFBSSx1QkFBYSxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUV0RSxNQUFNLG1CQUFtQixHQUFHLElBQUksNkJBQW1CLENBQUMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ2xGLE9BQU8sRUFBRSxZQUFZLEVBQUUsbUJBQW1CLEVBQUUsYUFBYSxFQUFFLG1CQUFtQixFQUFFLENBQUM7QUFDbkYsQ0FBQyxDQUFDO0FBaERXLFFBQUEsMEJBQTBCLDhCQWdEckMifQ==